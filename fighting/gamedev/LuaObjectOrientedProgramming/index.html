<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title># Lua Object Oriented Programming # | Notes.HF</title>
  <meta name="author" content="HuFei">
  
  <meta name="description" content="Notes of Learning">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="# Lua Object Oriented Programming #"/>
  <meta property="og:site_name" content="Notes.HF"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Notes.HF" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
</head>

<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Notes.HF</a></h1>
  <h2><a href="/">notes of buaaGS1521AA9.hufei | personal website | 3D Game Developer</a></h2>
</div>
<nav id="main-nav">
  <ul>
    
      <li><a href="/fighting/gamedev">Game Development</a></li>
    
      <li><a href="/fighting/finance">Finance Knowlodge</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
<div class="alignleft" style="margin-top: 15px">


</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="wrapper"><article class="page">
  
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/fighting/gamedev/LuaObjectOrientedProgramming/index.html"># Lua Object Oriented Programming #</a></h1>
  

      
    </header>
    <div class="entry">
      
        <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- Lua is not really an object-oriented language, and it doesn't have a built-in concept of classes.</span></span><br><span class="line"><span class="comment">--- But it is easily possible to create your own class system using tables and metatables.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- # Simple metatable-based class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> MyClass = &#123;&#125; <span class="comment">-- the table representing the class, which will double as the metatable for the instances</span></span><br><span class="line">MyClass.__index = MyClass <span class="comment">-- failed table lookups on the instances should fallback to the class table, to get methods</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- syntax equivalent to "MyClass.new = function..."</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyClass.new</span><span class="params">(init)</span></span></span><br><span class="line">    <span class="keyword">local</span> self = <span class="built_in">setmetatable</span>(&#123;&#125;, MyClass)</span><br><span class="line">    self.value = init</span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyClass.set_value</span><span class="params">(self, newval)</span></span></span><br><span class="line">    self.value = newval</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyClass.get_value</span><span class="params">(self)</span></span></span><br><span class="line">    <span class="keyword">return</span> self.value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i = MyClass.new(<span class="number">5</span>) <span class="comment">-- tbl:name(arg) is a shortcut for tbl.name(tbl,arg), except tbl is evaluated only once</span></span><br><span class="line"><span class="built_in">print</span>(i:get_value()) <span class="comment">--&gt; 5</span></span><br><span class="line">i:set_value(<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(i:get_value()) <span class="comment">--&gt; 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- First we create a table to represent the class and contain its methods. We also make it double as the metatable for</span></span><br><span class="line"><span class="comment">--- instances, but you can use a separate instance metatable if you like.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- In the constructor, we create the instance (an empty table), give it the metatable, fill in fields, and return the</span></span><br><span class="line"><span class="comment">--- new instance.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- In the methods, we use a "self" parameter to get the instance to operate on. This is so common that Lua offers the</span></span><br><span class="line"><span class="comment">--- syntax sugar ":" that calls a function entry from a table and inserts the table itself before the first arg.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- There are some improvements that can be made:</span></span><br><span class="line"><span class="keyword">local</span> MyClass = &#123;&#125;</span><br><span class="line">MyClass.__index = MyClass</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(MyClass, &#123;</span><br><span class="line">    __call = <span class="function"><span class="keyword">function</span><span class="params">(cls, ...)</span></span></span><br><span class="line">        <span class="keyword">return</span> cls.new(...)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyClass.new</span><span class="params">(init)</span></span></span><br><span class="line">    <span class="keyword">local</span> self = <span class="built_in">setmetatable</span>(&#123;&#125;, MyClass)</span><br><span class="line">    self.value = init</span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- the : syntax here causes a "self" arg to be implicitly added before any other args</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyClass:set_value</span><span class="params">(newval)</span></span></span><br><span class="line">    self.value = newval</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyClass:get_value</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> instance = MyClass(<span class="number">5</span>)</span><br><span class="line"><span class="comment">-- do some stuff with instance</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- Here we add a metatable to the class table that has the __call metamethod, which is triggered when a value is</span></span><br><span class="line"><span class="comment">--- called like a function. We make it call the class's constructor. so you don't need the ".new" when creating</span></span><br><span class="line"><span class="comment">--- instances. Another option would be to put the constructor right in the metamethod. In metamethods, "cls" refers</span></span><br><span class="line"><span class="comment">--- to the current table.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- Also, to complement the ":" method call shortcut, Lua lets you use ":" when defining a function in a table, which</span></span><br><span class="line"><span class="comment">--- implicitly adds a "self" argument so you don't have to type it out yourself.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- # Inheritance</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- It is easy to extend the design of the class in the above example to use inheritance:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> BaseClass = &#123;&#125;</span><br><span class="line">BaseClass.__index = BaseClass</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(BaseClass, &#123;</span><br><span class="line">    __call = <span class="function"><span class="keyword">function</span><span class="params">(cls, ...)</span></span></span><br><span class="line">        <span class="keyword">local</span> self = <span class="built_in">setmetatable</span>(&#123;&#125;, cls)</span><br><span class="line">        self:_init(...)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BaseClass:_init</span><span class="params">(init)</span></span></span><br><span class="line">    self.value = init</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BaseClass:set_value</span><span class="params">(newval)</span></span></span><br><span class="line">    self.value = newval</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BaseClass:get_value</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> DerivedClass = &#123;&#125;</span><br><span class="line">DerivedClass.__index = DerivedClass</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(DerivedClass, &#123;</span><br><span class="line">    __index = BaseClass, <span class="comment">-- this is what makes the inheritance work</span></span><br><span class="line">    __call = <span class="function"><span class="keyword">function</span><span class="params">(cls, ...)</span></span></span><br><span class="line">        <span class="keyword">local</span> self = <span class="built_in">setmetatable</span>(&#123;&#125;, cls)</span><br><span class="line">        self:_init(...)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DerivedClass:_init</span><span class="params">(init1, init2)</span></span></span><br><span class="line">    BaseClass._init(self, init1) <span class="comment">-- call the base class constructor</span></span><br><span class="line">    self.value2 = init2</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DerivedClass:get_value</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.value + self.value2</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i = DerivedClass(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(i:get_value()) <span class="comment">--&gt; 3</span></span><br><span class="line">i:set_value(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(i:get_value()) <span class="comment">--&gt; 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- Here we have derived class table an __index metamethod that makes it inherit the base class. Also we moved the</span></span><br><span class="line"><span class="comment">--- creating of the instance into the __call metamethods, and turned the constructors purely into initialization</span></span><br><span class="line"><span class="comment">--- methods. This is so that the derived class can call the base class initialization function on itself.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- One final optimization that can be done is to copy the contents of the base class into the derived class instead</span></span><br><span class="line"><span class="comment">--- of using __index. This avoids the long __index chain that can slow down method calls, and also makes it so that</span></span><br><span class="line"><span class="comment">--- if the base class has methods like __add, they will work like proper metamethods on the derived class. This is</span></span><br><span class="line"><span class="comment">--- because __index is not follows when looking for metamethods:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> DerivedClass = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(BaseClass) <span class="keyword">do</span></span><br><span class="line">    DerivedClass[k] = v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">DerivedClass.__index = DerivedClass</span><br><span class="line"></span><br><span class="line"><span class="comment">--- # Class creation function</span></span><br><span class="line"><span class="comment">--- Knowing all this, it's possible to create a convenience function that creates classes, optionally inheriting</span></span><br><span class="line"><span class="comment">--- from other classes. Here is an example of such a function:</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="comment">-- "cls" is the new class</span></span><br><span class="line">    <span class="keyword">local</span> cls, bases = &#123;&#125;, &#123; ... &#125;</span><br><span class="line">    <span class="comment">-- copy base class contents into the new class</span></span><br><span class="line">    <span class="keyword">for</span> i, base <span class="keyword">in</span> <span class="built_in">ipairs</span>(bases) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(base) <span class="keyword">do</span></span><br><span class="line">            cls[k] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- set the class's __index, and start filling an "is_a" table that contains this class and all of its bases so you</span></span><br><span class="line">    <span class="comment">-- can do an "instance of" check using my_instance.is_a[MyClass]</span></span><br><span class="line">    cls.__index, cls.is_a = cls, &#123; [cls] = <span class="keyword">true</span> &#125;</span><br><span class="line">    <span class="keyword">for</span> i, base <span class="keyword">in</span> <span class="built_in">ipairs</span>(bases) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">ipairs</span>(base.is_a) <span class="keyword">do</span></span><br><span class="line">            cls.is_a[c] = <span class="keyword">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        cls.is_a[base] = <span class="keyword">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- the class's __call metamethod</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(cls, &#123; __call = <span class="function"><span class="keyword">function</span><span class="params">(c, ...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance = instance._init</span><br><span class="line">        <span class="keyword">if</span> init <span class="keyword">then</span></span><br><span class="line">            init(instance, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    <span class="keyword">end</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- return the new class table, that's ready to fill with methods</span></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- # Closure-based objects</span></span><br><span class="line"><span class="comment">--- It's also possible to make objects using closures. Instances are slower to create and use more memory, but there</span></span><br><span class="line"><span class="comment">--- are also some advantages(like faster instance field access), and it's an interesting example of how cloures can be</span></span><br><span class="line"><span class="comment">--- used.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">MyClass</span><span class="params">(init)</span></span></span><br><span class="line">    <span class="comment">-- the new instance</span></span><br><span class="line">    <span class="keyword">local</span> self = &#123;</span><br><span class="line">        <span class="comment">-- public fields go in instance setmetatable</span></span><br><span class="line">        public_field = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- private fields are implemented using locals</span></span><br><span class="line">    <span class="comment">-- they are faster than table access, and are truly private, so the code that uses your class can't get them</span></span><br><span class="line">    <span class="keyword">local</span> private_field = init</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">self.foo</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> self.public_field + private_field</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">self.bar</span><span class="params">()</span></span></span><br><span class="line">        private_field = private_field + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- return the instance</span></span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i = MyClass(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(i.foo()) <span class="comment">--&gt; 5</span></span><br><span class="line">i.public_field = <span class="number">3</span></span><br><span class="line">i.bar()</span><br><span class="line"><span class="built_in">print</span>(i.foo()) <span class="comment">--&gt; 9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--- Notice that the "." syntax was used to call methods, not ":". This is because the self variable is already stored</span></span><br><span class="line"><span class="comment">--- in the methods as an upvalue, so it doesn't need to be passed in by the code calling it.</span></span><br><span class="line"><span class="comment">--- Inheritance is also possible this way:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">BaseClass</span><span class="params">(init)</span></span></span><br><span class="line">    <span class="keyword">local</span> self = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> private_field = init</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">self.foo</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> private_field</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">self.bar</span><span class="params">()</span></span></span><br><span class="line">        private_field = private_field + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- return the instance</span></span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">DerivedClass</span><span class="params">(init, init2)</span></span></span><br><span class="line">    <span class="keyword">local</span> self = BaseClass(init)</span><br><span class="line">    self.public_field = init2</span><br><span class="line">    <span class="comment">-- this is independent from the base class's private field that has the same name</span></span><br><span class="line">    <span class="keyword">local</span> private_field = init2</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- save the base version of foo for use in the derived verion</span></span><br><span class="line">    <span class="keyword">local</span> base_foo = self.foo</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">self.foo</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> private_field + self.public_field + base_foo()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- return the instance</span></span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i = DerivedClass(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(i.foo()) <span class="comment">--&gt; 5</span></span><br><span class="line">i.bar()</span><br><span class="line"><span class="built_in">print</span>(i.foo()) <span class="comment">--&gt; 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- # Table VS. Closure-based classes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- Advantages of table-based:</span></span><br><span class="line"><span class="comment">--- (1) Creating instances of table-based classes is faster, since you only create the instance table and its fields,</span></span><br><span class="line"><span class="comment">--- and the methods are shared by all instacnes.</span></span><br><span class="line"><span class="comment">--- (2) Table-based instances use less memory, since the methods are not duplicated for each instance.</span></span><br><span class="line"><span class="comment">--- (3) It's possible to get a method directly from the class, for examlpe, MyClass.method(instance, arg).</span></span><br><span class="line"><span class="comment">--- (4) Many Lua developers might find ":" for method calls more consistent with the vast majority of object-oriented</span></span><br><span class="line"><span class="comment">--- Lua code.</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- Advantages of closure-based:</span></span><br><span class="line"><span class="comment">--- (1) Closure-based instances can have truly private field, so that the users of your class cannot accidentally or</span></span><br><span class="line"><span class="comment">--- intentionally get to them.</span></span><br><span class="line"><span class="comment">--- (2) Access to private fields is faster with closure-based classes, since they are upvalues, not table lookups.</span></span><br><span class="line"><span class="comment">--- (3) Method calls are faster, since they don't have to go through an __index metamethod.</span></span><br><span class="line"><span class="comment">--- (4) Many developers from other languages may find the .method call syntax more familiar.</span></span><br><span class="line"><span class="comment">---</span></span><br></pre></td></tr></table></figure>
<p>End.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>
<!-- hackish -->
</div>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2018 HuFei
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="http://apps.bdimg.com/libs/fancybox/2.1.5/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>